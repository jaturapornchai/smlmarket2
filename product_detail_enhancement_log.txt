🔧 **การปรับปรุงหน้าจอรายละเอียดสินค้า (Product Detail Screen)**
==================================================================

**วันที่**: 24 มิถุนายน 2025
**เวลา**: 15:15 น.

## 🎯 เป้าหมาย
นำ concept การ refresh ยอดคงเหลือแบบ real-time จากหน้าตะกร้าสินค้ามาใช้ในหน้าจอรายละเอียดสินค้าด้วย

## 🔧 การแก้ไขที่ทำ

### 1. เพิ่ม Method ใหม่ใน CartCubit
✅ เพิ่ม `refreshSingleStockQuantity()` สำหรับ refresh ยอดคงเหลือของสินค้าเดียว
```dart
Future<void> refreshSingleStockQuantity({required String icCode})
```

### 2. ปรับปรุง Product Detail Screen
✅ **initState()**: เพิ่มการโหลดยอดคงเหลือเริ่มต้น
```dart
void _loadStockQuantity() {
  final cartCubit = context.read<CartCubit>();
  final icCode = widget.product.id ?? '';
  if (icCode.isNotEmpty) {
    cartCubit.refreshSingleStockQuantity(icCode: icCode);
  }
}
```

✅ **_buildStockStatus()**: ใช้ `BlocBuilder` เพื่อดึงยอดคงเหลือจาก CartCubit
- ใช้ยอดคงเหลือจาก `state.stockQuantities[icCode]` แทน `widget.product.qtyAvailable`
- มี fallback กลับไปใช้ `widget.product.qtyAvailable` ถ้าไม่พบใน state
- มี `buildWhen` เพื่อ rebuild เฉพาะเมื่อยอดคงเหลือของสินค้านี้เปลี่ยน

✅ **_addToCart()**: ปรับปรุงการตรวจสอบสต็อกและ refresh หลังเพิ่มลงตะกร้า
- ตรวจสอบยอดคงเหลือล่าสุดจาก CartCubit ก่อนเพิ่มลงตะกร้า
- หลังเพิ่มลงตะกร้าสำเร็จ → refresh ยอดคงเหลือทันที
- ไม่ปิดหน้าทันที เพื่อให้ผู้ใช้เห็นยอดคงเหลือใหม่

## 🧪 ผลลัพธ์ที่คาดหวัง

1. **เมื่อเปิดหน้าจอรายละเอียดสินค้า**:
   - แสดงยอดคงเหลือล่าสุดจากฐานข้อมูล (ไม่ใช่ข้อมูลเก่าจากการค้นหา)

2. **เมื่อเพิ่มสินค้าลงตะกร้า**:
   - ตรวจสอบยอดคงเหลือล่าสุดก่อนเพิ่ม
   - หลังเพิ่มสำเร็จ → ยอดคงเหลือลดลงทันทีในหน้าจอ
   - ถ้าสินค้าหมด → แสดง "สินค้าหมด" แบบ real-time

3. **Integration กับหน้าตะกร้าสินค้า**:
   - ยอดคงเหลือใน Product Detail และ Cart Screen sync กัน
   - ข้อมูลเป็น real-time และถูกต้องทั้งสองหน้า

## 🔄 สถานะ: ✅ เสร็จสิ้น - พร้อมทดสอบ

### 📊 สถานะปัจจุบันของแอป:
- ✅ แอปรันสำเร็จบน Windows
- ✅ ตะกร้าปัจจุบันมี 2 รายการ: 
  - `JT036`: 41 ชิ้น, ยอดคงเหลือ 63.0 ชิ้น  
  - `C-TOYOTA-7198`: 8 ชิ้น, ยอดคงเหลือ 15.0 ชิ้น

### 🧪 วิธีทดสอบการแก้ไข:

**ขั้นตอนที่ 1: ทดสอบการโหลดยอดคงเหลือใน Product Detail**
1. ไปที่หน้าค้นหาสินค้า
2. ค้นหาสินค้า `JT036` หรือ `C-TOYOTA-7198`  
3. กดดูรายละเอียดสินค้า
4. ✅ **คาดหวัง**: ยอดคงเหลือแสดง 63 ชิ้น (JT036) หรือ 15 ชิ้น (C-TOYOTA-7198)

**ขั้นตอนที่ 2: ทดสอบการ Refresh หลังเพิ่มลงตะกร้า**
1. ในหน้ารายละเอียดสินค้า JT036 
2. เพิ่มสินค้า 1 ชิ้นลงตะกร้า
3. ✅ **คาดหวัง**: ยอดคงเหลือเปลี่ยนจาก "63 ชิ้น" → "62 ชิ้น" ทันที
4. ไม่ปิดหน้าทันที เพื่อให้เห็นการเปลี่ยนแปลง

**ขั้นตอนที่ 3: ทดสอบ Integration กับหน้าตะกร้า**
1. เข้าไปดูหน้าตะกร้าสินค้า
2. ✅ **คาดหวัง**: ยอดคงเหลือใน cart ก็เป็น 62 ชิ้นเช่นกัน
3. อัปเดตจำนวนในตะกร้า JT036 จาก 42 → 40 ชิ้น
4. กลับไปดูหน้ารายละเอียดสินค้า JT036 อีกครั้ง
5. ✅ **คาดหวัง**: ยอดคงเหลือเป็น 64 ชิ้น (เพิ่มขึ้น 2 ชิ้น)

ตอนนี้พร้อมทดสอบแล้ว! 🚀
