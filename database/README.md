# ЁЯЧГя╕П Database Setup for SML Market

This directory contains SQL scripts for setting up the SML Market database with cart and order management system.

## ЁЯУБ Files

### Main Scripts
- `recreate_cart_system.sql` - **р╣Гр╕лр╕бр╣И!** р╕кр╕гр╣Йр╕▓р╕Зр╕гр╕░р╕Ър╕Ър╕Хр╕░р╕Бр╕гр╣Йр╕▓р╣Бр╕ер╕░р╕нр╕нр╣Ар╕Фр╕нр╕гр╣Мр╣Гр╕лр╕бр╣Ир╕Чр╕▒р╣Йр╕Зр╕лр╕бр╕Ф
- `test_data_cart_system.sql` - **р╣Гр╕лр╕бр╣И!** р╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Чр╕Фр╕кр╕нр╕Ър╕кр╕│р╕лр╕гр╕▒р╕Ър╕гр╕░р╕Ър╕Ър╕Хр╕░р╕Бр╕гр╣Йр╕▓
- `setup_cart_system.bat` - **р╣Гр╕лр╕бр╣И!** Script р╕гр╕▒р╕Щр╕нр╕▒р╕Хр╣Вр╕Щр╕бр╕▒р╕Хр╕┤р╕Ър╕Щ Windows

### Legacy Files
- `cart_system_postgresql.sql` - Schema р╣Ар╕Фр╕┤р╕б (р╕кр╕│р╕лр╕гр╕▒р╕Ър╕нр╣Йр╕▓р╕Зр╕нр╕┤р╕З)
- `test_data.sql` - р╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Чр╕Фр╕кр╕нр╕Ър╣Ар╕Фр╕┤р╕б
- `setup_test_data.sh` - Script р╣Ар╕Фр╕┤р╕бр╕кр╕│р╕лр╕гр╕▒р╕Ъ Linux/Mac

## ЁЯЪА Quick Setup (р╣Бр╕Щр╕░р╕Щр╕│)

### р╕кр╕│р╕лр╕гр╕▒р╕Ъ Windows:
```cmd
cd database
setup_cart_system.bat
```

### р╕кр╕│р╕лр╕гр╕▒р╕Ъ Linux/Mac:
```bash
cd database
psql -h localhost -d smlmarket -U postgres -f recreate_cart_system.sql
psql -h localhost -d smlmarket -U postgres -f test_data_cart_system.sql
```

## ЁЯУК Database Schema р╣Гр╕лр╕бр╣И

### ЁЯЫТ р╕Хр╕▓р╕гр╕▓р╕З carts (р╕Хр╕░р╕Бр╕гр╣Йр╕▓р╕лр╕ер╕▒р╕Б)
- `id` - р╕гр╕лр╕▒р╕кр╕Хр╕░р╕Бр╕гр╣Йр╕▓ (Primary Key)
- `customer_id` - р╕гр╕лр╕▒р╕кр╕ер╕╣р╕Бр╕Др╣Йр╕▓
- `status` - р╕кр╕Цр╕▓р╕Щр╕░ (active, completed, cancelled)
- `total_amount` - р╕вр╕нр╕Фр╕гр╕зр╕б (р╕нр╕▒р╕Ыр╣Ар╕Фр╕Хр╕нр╕▒р╕Хр╣Вр╕Щр╕бр╕▒р╕Хр╕┤)
- `total_items` - р╕Ир╕│р╕Щр╕зр╕Щр╕гр╕▓р╕вр╕Бр╕▓р╕г (р╕нр╕▒р╕Ыр╣Ар╕Фр╕Хр╕нр╕▒р╕Хр╣Вр╕Щр╕бр╕▒р╕Хр╕┤)
- `created_at`, `updated_at` - р╕зр╕▒р╕Щр╕Чр╕╡р╣И

### ЁЯЫНя╕П р╕Хр╕▓р╕гр╕▓р╕З cart_items (р╕кр╕┤р╕Щр╕Др╣Йр╕▓р╣Гр╕Щр╕Хр╕░р╕Бр╕гр╣Йр╕▓)
- `id` - р╕гр╕лр╕▒р╕кр╕гр╕▓р╕вр╕Бр╕▓р╕г (Primary Key)
- `cart_id` - р╕гр╕лр╕▒р╕кр╕Хр╕░р╕Бр╕гр╣Йр╕▓ (Foreign Key)
- `ic_code` - р╕гр╕лр╕▒р╕кр╕кр╕┤р╕Щр╕Др╣Йр╕▓р╕Ир╕▓р╕Б ic_inventory
- `barcode`, `unit_code` - р╕Вр╣Йр╕нр╕бр╕╣р╕ер╕кр╕┤р╕Щр╕Др╣Йр╕▓
- `quantity`, `unit_price`, `total_price` - р╕Вр╣Йр╕нр╕бр╕╣р╕ер╕гр╕▓р╕Др╕▓
- Unique constraint: р╣Др╕бр╣Ир╣Гр╕лр╣Йр╕бр╕╡р╕кр╕┤р╕Щр╕Др╣Йр╕▓р╕Лр╣Йр╕│р╣Гр╕Щр╕Хр╕░р╕Бр╕гр╣Йр╕▓

### ЁЯУж р╕Хр╕▓р╕гр╕▓р╕З orders (р╕Др╕│р╕кр╕▒р╣Ир╕Зр╕Лр╕╖р╣Йр╕н)
- `id` - р╕гр╕лр╕▒р╕кр╕нр╕нр╣Ар╕Фр╕нр╕гр╣М (Primary Key)
- `cart_id` - р╕гр╕лр╕▒р╕кр╕Хр╕░р╕Бр╕гр╣Йр╕▓р╕Чр╕╡р╣Ир╕кр╕гр╣Йр╕▓р╕Зр╕нр╕нр╣Ар╕Фр╕нр╕гр╣М
- `customer_id` - р╕гр╕лр╕▒р╕кр╕ер╕╣р╕Бр╕Др╣Йр╕▓
- `order_number` - р╕лр╕бр╕▓р╕вр╣Ар╕ер╕Вр╕нр╕нр╣Ар╕Фр╕нр╕гр╣М (Unique)
- `status` - р╕кр╕Цр╕▓р╕Щр╕░р╕нр╕нр╣Ар╕Фр╕нр╕гр╣М
- `payment_status` - р╕кр╕Цр╕▓р╕Щр╕░р╕Бр╕▓р╕гр╕Кр╕│р╕гр╕░р╣Ар╕Зр╕┤р╕Щ
- р╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Ир╕▒р╕Фр╕кр╣Ир╕Зр╣Бр╕ер╕░р╕Бр╕▓р╕гр╕Кр╕│р╕гр╕░р╣Ар╕Зр╕┤р╕Щ

### ЁЯУЛ р╕Хр╕▓р╕гр╕▓р╕З order_items (р╕кр╕┤р╕Щр╕Др╣Йр╕▓р╣Гр╕Щр╕нр╕нр╣Ар╕Фр╕нр╕гр╣М)
- `id` - р╕гр╕лр╕▒р╕кр╕гр╕▓р╕вр╕Бр╕▓р╕г (Primary Key)
- `order_id` - р╕гр╕лр╕▒р╕кр╕нр╕нр╣Ар╕Фр╕нр╕гр╣М (Foreign Key)
- р╕Вр╣Йр╕нр╕бр╕╣р╕ер╕кр╕┤р╕Щр╕Др╣Йр╕▓р╣Бр╕ер╕░р╕гр╕▓р╕Др╕▓ (copy р╕Ир╕▓р╕Б cart_items)

## ЁЯФз Features р╣Гр╕лр╕бр╣И

### Auto-Update Triggers
- р╕нр╕▒р╕Ыр╣Ар╕Фр╕Х `updated_at` р╕нр╕▒р╕Хр╣Вр╕Щр╕бр╕▒р╕Хр╕┤р╣Ар╕бр╕╖р╣Ир╕нр╕бр╕╡р╕Бр╕▓р╕гр╣Бр╕Бр╣Йр╣Др╕В
- р╕нр╕▒р╕Ыр╣Ар╕Фр╕Х `total_amount` р╣Бр╕ер╕░ `total_items` р╣Гр╕Щр╕Хр╕░р╕Бр╕гр╣Йр╕▓р╕нр╕▒р╕Хр╣Вр╕Щр╕бр╕▒р╕Хр╕┤

### Functions
- `update_cart_totals(cart_id)` - р╕нр╕▒р╕Ыр╣Ар╕Фр╕Хр╕вр╕нр╕Фр╕гр╕зр╕бр╣Гр╕Щр╕Хр╕░р╕Бр╕гр╣Йр╕▓
- Trigger functions р╕кр╕│р╕лр╕гр╕▒р╕Ър╕нр╕▒р╕Ыр╣Ар╕Фр╕Хр╕нр╕▒р╕Хр╣Вр╕Щр╕бр╕▒р╕Хр╕┤

### Indexes
- р╣Ар╕Юр╕┤р╣Ир╕б indexes р╕кр╕│р╕лр╕гр╕▒р╕Ър╕Ыр╕гр╕░р╕кр╕┤р╕Чр╕Шр╕┤р╕ар╕▓р╕Ю
- Index р╕Ър╕Щ customer_id, status, cart_id

### Data Validation
- CHECK constraints р╕кр╕│р╕лр╕гр╕▒р╕Ър╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Чр╕╡р╣Ир╕Цр╕╣р╕Бр╕Хр╣Йр╕нр╕З
- Foreign Key constraints р╕кр╕│р╕лр╕гр╕▒р╕Ър╕Др╕зр╕▓р╕бр╕кр╕бр╕Ър╕╣р╕гр╕Ур╣Мр╕Вр╕нр╕Зр╕Вр╣Йр╕нр╕бр╕╣р╕е

## ЁЯзк Test Data

р╕лр╕ер╕▒р╕Зр╕Ир╕▓р╕Бр╕гр╕▒р╕Щ script р╣Бр╕ер╣Йр╕зр╕Ир╕░р╕бр╕╡р╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Чр╕Фр╕кр╕нр╕Ъ:
- р╕ер╕╣р╕Бр╕Др╣Йр╕▓ ID 1: р╕Хр╕░р╕Бр╕гр╣Йр╕▓ active р╕бр╕╡ 3 р╕гр╕▓р╕вр╕Бр╕▓р╕г (р╕гр╕зр╕б р╕┐11,780)
- р╕ер╕╣р╕Бр╕Др╣Йр╕▓ ID 2: р╕Хр╕░р╕Бр╕гр╣Йр╕▓ active р╕зр╣Ир╕▓р╕З
- р╕нр╕нр╣Ар╕Фр╕нр╕гр╣Мр╕Хр╕▒р╕зр╕нр╕вр╣Ир╕▓р╕З 1 р╕гр╕▓р╕вр╕Бр╕▓р╕г (delivered)

## тЪб р╕Бр╕▓р╕гр╣Гр╕Кр╣Йр╕Зр╕▓р╕Щр╕Бр╕▒р╕Ъ Flutter App

р╕гр╕░р╕Ър╕Ър╕Щр╕╡р╣Йр╕Цр╕╣р╕Бр╕нр╕нр╕Бр╣Бр╕Ър╕Ър╣Гр╕лр╣Йр╕Чр╕│р╕Зр╕▓р╕Щр╕Бр╕▒р╕Ъ:
- `CartRemoteDataSource` р╣Гр╕Щ Flutter app
- API endpoints: `/pgselect`, `/pgcommand`
- SQL queries р╕Чр╕╡р╣Ир╕гр╕░р╕Ър╕╕р╣Гр╕Щ app

## ЁЯФН р╕Бр╕▓р╕гр╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ъ

```sql
-- р╕Фр╕╣р╕Хр╕░р╕Бр╕гр╣Йр╕▓р╕Чр╕▒р╣Йр╕Зр╕лр╕бр╕Ф
SELECT * FROM carts ORDER BY id;

-- р╕Фр╕╣р╕кр╕┤р╕Щр╕Др╣Йр╕▓р╣Гр╕Щр╕Хр╕░р╕Бр╕гр╣Йр╕▓
SELECT c.customer_id, ci.* 
FROM cart_items ci 
JOIN carts c ON ci.cart_id = c.id 
ORDER BY ci.cart_id;

-- р╕Фр╕╣р╕нр╕нр╣Ар╕Фр╕нр╕гр╣М
SELECT * FROM orders ORDER BY id;
```

## тЪая╕П р╕лр╕бр╕▓р╕вр╣Ар╕лр╕Хр╕╕

- Script р╕Ир╕░р╕ер╕Ър╕Хр╕▓р╕гр╕▓р╕Зр╣Ар╕Бр╣Ир╕▓р╣Бр╕ер╕░р╕кр╕гр╣Йр╕▓р╕Зр╣Гр╕лр╕бр╣Ир╕Чр╕▒р╣Йр╕Зр╕лр╕бр╕Ф
- р╕Вр╣Йр╕нр╕бр╕╣р╕ер╣Ар╕Бр╣Ир╕▓р╕Ир╕░р╕лр╕▓р╕вр╣Др╕Ы - р╣Гр╕Кр╣Йр╣Ар╕Йр╕Юр╕▓р╕░р╣Гр╕Щ Development
- Production р╕Др╕зр╕гр╣Гр╕Кр╣Й Migration scripts р╣Бр╕Чр╕Щ
